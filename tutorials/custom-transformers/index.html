
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Lexy is a data platform for building AI applications." name="description"/>
<link href="https://getlexy.com/tutorials/custom-transformers/" rel="canonical"/>
<link href="../multimodal-image-search/" rel="prev"/>
<link href="../document-filters/" rel="next"/>
<link href="../../assets/public/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-9.5.15" name="generator"/>
<title>Custom transformers - Lexy AI</title>
<link href="../../assets/stylesheets/main.7e359304.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../assets/_mkdocstrings.css" rel="stylesheet"/>
<link href="../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-GXKGDFL4B1"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-GXKGDFL4B1",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-GXKGDFL4B1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#custom-transformers">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Lexy AI" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Lexy AI">
<img alt="logo" src="../../assets/public/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Lexy AI
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Custom transformers
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="pink" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"></path></svg>
</label>
</form>
<script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/lexy-ai/lexy" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"></path></svg>
</div>
<div class="md-source__repository">
    lexy-ai/lexy
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Lexy AI" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Lexy AI">
<img alt="logo" src="../../assets/public/logo.png"/>
</a>
    Lexy AI
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/lexy-ai/lexy" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"></path></svg>
</div>
<div class="md-source__repository">
    lexy-ai/lexy
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../installation/">
<span class="md-ellipsis">
    Installation
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../quickstart/">
<span class="md-ellipsis">
    Quickstart
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Tutorials
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../basic-rag/">
<span class="md-ellipsis">
    Retrieval Augmented Generation (RAG)
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../multimodal-image-search/">
<span class="md-ellipsis">
    Multimodal image search
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Custom transformers
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Custom transformers
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#project-structure">
<span class="md-ellipsis">
      Project structure
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#add-transformer-logic">
<span class="md-ellipsis">
      Add transformer logic
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#install-optional-dependencies">
<span class="md-ellipsis">
      Install optional dependencies
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#create-transformer">
<span class="md-ellipsis">
      Create transformer
    </span>
</a>
<nav aria-label="Create transformer" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#testing-with-sample-documents">
<span class="md-ellipsis">
      Testing with sample documents
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updating-transformer-logic">
<span class="md-ellipsis">
      Updating transformer logic
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../document-filters/">
<span class="md-ellipsis">
    Document filters
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../structured-data-extraction/">
<span class="md-ellipsis">
    Structured data extraction
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../reference/rest-api/">
<span class="md-ellipsis">
    REST API
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Python SDK
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Python SDK
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../reference/lexy_py/binding/">
<span class="md-ellipsis">
    Binding
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../reference/lexy_py/client/">
<span class="md-ellipsis">
    Client
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../reference/lexy_py/collection/">
<span class="md-ellipsis">
    Collection
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../reference/lexy_py/document/">
<span class="md-ellipsis">
    Document
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../reference/lexy_py/filters/">
<span class="md-ellipsis">
    Filters
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../reference/lexy_py/indexes/">
<span class="md-ellipsis">
    Index
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../reference/lexy_py/transformer/">
<span class="md-ellipsis">
    Transformer
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../contributing/">
<span class="md-ellipsis">
    Contributing
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../faq/">
<span class="md-ellipsis">
    FAQ
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#project-structure">
<span class="md-ellipsis">
      Project structure
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#add-transformer-logic">
<span class="md-ellipsis">
      Add transformer logic
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#install-optional-dependencies">
<span class="md-ellipsis">
      Install optional dependencies
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#create-transformer">
<span class="md-ellipsis">
      Create transformer
    </span>
</a>
<nav aria-label="Create transformer" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#testing-with-sample-documents">
<span class="md-ellipsis">
      Testing with sample documents
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#updating-transformer-logic">
<span class="md-ellipsis">
      Updating transformer logic
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="custom-transformers">Custom transformers</h1>
<p>This tutorial shows how to create custom transformers for use in your data pipelines.</p>
<p>Up until now, we've only used the default transformers included in Lexy. These include common methods for embedding text
and images. But we'll often want to apply custom transformations to our documents based on metadata or our own custom
logic. In this tutorial, we'll create our own transformer for parsing comments from source code.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Currently, there is no clear distinction between "transformers" and "pipelines."
They can be used interchangeably. This will change in upcoming versions of Lexy,
when we introduce additional functionality for pipelines.</p>
</div>
<h2 id="project-structure">Project structure</h2>
<p>Let's take a look at our project structure. If we're working inside the Lexy repository,
the structure will look like this:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>lexy
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>├──<span class="w"> </span>...
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>├──<span class="w"> </span>pipelines<span class="w">  </span><span class="c1"># (1)!</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>│<span class="w">   </span>├──<span class="w"> </span>__init__.py
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>│<span class="w">   </span>└──<span class="w"> </span>requirements.txt<span class="w">  </span><span class="c1"># (2)!</span>
</span></code></pre></div>
<ol>
<li>This is the Lexy pipelines directory, defined by the environment variable
    <code>PIPELINE_DIR</code>. The modules in this directory are imported and run by the
    <code>lexyworker</code> container.</li>
<li>Extra requirements for your pipelines or custom transformers. These packages will
    be installed whenever you restart the <code>lexyworker</code> container.</li>
</ol>
<p>And if you're using Lexy inside your own project, the structure might look like the one
in the <a href="../../quickstart/#building-with-lexy">Quickstart</a> guide. Either way, you'll have
a <code>pipelines</code> directory where you can store your custom transformers.</p>
<h2 id="add-transformer-logic">Add transformer logic</h2>
<p>Let's add a new module in the pipelines directory called <code>code</code>.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>lexy
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>├── ...
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>├── pipelines
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>│   ├── __init__.py
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="hll">│   ├── code.py
</span></span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>│   └── requirements.txt
</span></code></pre></div>
<p>And let's add the following to our file <code>code.py</code>:</p>
<div class="language-python highlight"><span class="filename">pipelines/code.py</span><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">from</span> <span class="nn">lexy.models</span> <span class="kn">import</span> <span class="n">Document</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">from</span> <span class="nn">lexy.transformers</span> <span class="kn">import</span> <span class="n">lexy_transformer</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="k">def</span> <span class="nf">parse_code</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="c1"># just an example - replace with your own logic</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="k">return</span> <span class="p">[</span>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>        <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="s1">'my comment'</span><span class="p">,</span> <span class="s1">'line_no'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'filename'</span><span class="p">:</span> <span class="s1">'example.py'</span><span class="p">}</span>
</span><span id="__span-2-9"><a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="p">]</span>
</span><span id="__span-2-10"><a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>
</span><span id="__span-2-11"><a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>
</span><span id="__span-2-12"><a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="nd">@lexy_transformer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'code.extract_comments.v1'</span><span class="p">)</span>  <span class="c1"># (1)!</span>
</span><span id="__span-2-13"><a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="k">def</span> <span class="nf">get_comments</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="n">Document</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
</span><span id="__span-2-14"><a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>    <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-2-15"><a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">parse_code</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
</span><span id="__span-2-16"><a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-2-17"><a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>            <span class="s1">'comment_text'</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">'text'</span><span class="p">],</span>
</span><span id="__span-2-18"><a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>            <span class="s1">'comment_meta'</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-2-19"><a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>                <span class="s1">'line_no'</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">'line_no'</span><span class="p">],</span>
</span><span id="__span-2-20"><a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>                <span class="s1">'filename'</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">]</span>
</span><span id="__span-2-21"><a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>            <span class="p">}</span>
</span><span id="__span-2-22"><a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>        <span class="p">})</span>
</span><span id="__span-2-23"><a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a>    <span class="k">return</span> <span class="n">comments</span>
</span></code></pre></div>
<ol>
<li>The <code>@lexy_transformer</code> decorator registers your function as a transformer. The
    <code>name</code> argument is the transformer ID. This is how you'll refer to your transformer
    when creating bindings. The <code>name</code> should be unique across all transformers.</li>
</ol>
<h2 id="install-optional-dependencies">Install optional dependencies</h2>
<p>Make sure to install any package dependencies required for your custom transformer code.
You can do this by adding the package to the <code>requirements.txt</code> file in the <code>pipelines</code>
directory and restarting the <code>lexyworker</code> container.</p>
<div class="language-text highlight"><span class="filename">pipelines/requirements.txt</span><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a># Extra package requirements for pipelines
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="hll">tree-sitter==0.20.4
</span></span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="hll">tree-sitter-languages==1.8.0
</span></span></code></pre></div>
<p>Then restart the <code>lexyworker</code> container:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>docker<span class="w"> </span>compose<span class="w"> </span>restart<span class="w"> </span>lexyworker
</span></code></pre></div>
<p>You can check the <code>lexyworker</code> container logs to see that the packages are being
installed correctly. You can also check the <code>pip install</code> logs by running:</p>
<div class="language-Shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>docker<span class="w"> </span>compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>lexyworker<span class="w"> </span>tail<span class="w"> </span>/var/log/lexy-pip.log
</span></code></pre></div>
<h2 id="create-transformer">Create transformer</h2>
<p>Finally, create your transformer so that it's stored in the database and available to
the Lexy server. You can do this by calling the <a href="../../reference/lexy_py/transformer/#lexy_py.transformer.client.TransformerClient.create_transformer"><code>create_transformer</code></a> method.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">from</span> <span class="nn">lexy_py</span> <span class="kn">import</span> <span class="n">LexyClient</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="n">lx</span> <span class="o">=</span> <span class="n">LexyClient</span><span class="p">()</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="n">lx</span><span class="o">.</span><span class="n">create_transformer</span><span class="p">(</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="n">transformer_id</span><span class="o">=</span><span class="s1">'code.extract_comments.v1'</span><span class="p">,</span>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>    <span class="n">description</span><span class="o">=</span><span class="s1">'Parse comments and docstrings.'</span>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="p">)</span>
</span></code></pre></div>
<div class="language-text no-copy result highlight" id="code-output"><pre><span></span><code><span id="__span-code-output-1"><a href="#__codelineno-code-output-1" id="__codelineno-code-output-1" name="__codelineno-code-output-1"></a>&lt;Transformer('code.extract_comments.v1', description='Parse comments and docstrings')&gt;
</span></code></pre></div>
<p>Now when you call the <a href="../../reference/lexy_py/client/#lexy_py.client.LexyClient.transformers"><code>.transformers</code></a> property of the Lexy client, you'll be
able to see your transformer listed.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">lx</span><span class="o">.</span><span class="n">transformers</span>
</span></code></pre></div>
<div class="language-text no-copy result highlight" id="code-output"><pre><span></span><code><span id="__span-code-output-1"><a href="#__codelineno-code-output-1" id="__codelineno-code-output-1" name="__codelineno-code-output-1"></a>[&lt;Transformer('image.embeddings.clip', description='Embed images using 'openai/clip-vit-base-patch32'.')&gt;,
</span><span id="__span-code-output-2"><a href="#__codelineno-code-output-2" id="__codelineno-code-output-2" name="__codelineno-code-output-2"></a> &lt;Transformer('text.embeddings.clip', description='Embed text using 'openai/clip-vit-base-patch32'.')&gt;,
</span><span id="__span-code-output-3"><a href="#__codelineno-code-output-3" id="__codelineno-code-output-3" name="__codelineno-code-output-3"></a> &lt;Transformer('text.embeddings.minilm', description='Text embeddings using "sentence-transformers/all-MiniLM-L6-v2"')&gt;,
</span><span id="__span-code-output-4"><a href="#__codelineno-code-output-4" id="__codelineno-code-output-4" name="__codelineno-code-output-4"></a> &lt;Transformer('text.embeddings.openai-3-large', description='Text embeddings using OpenAI's "text-embedding-3-large" model')&gt;,
</span><span id="__span-code-output-5"><a href="#__codelineno-code-output-5" id="__codelineno-code-output-5" name="__codelineno-code-output-5"></a> &lt;Transformer('text.embeddings.openai-3-small', description='Text embeddings using OpenAI's "text-embedding-3-small" model')&gt;,
</span><span id="__span-code-output-6"><a href="#__codelineno-code-output-6" id="__codelineno-code-output-6" name="__codelineno-code-output-6"></a> &lt;Transformer('text.embeddings.openai-ada-002', description='OpenAI text embeddings using model text-embedding-ada-002')&gt;,
</span><span id="__span-code-output-7"><a href="#__codelineno-code-output-7" id="__codelineno-code-output-7" name="__codelineno-code-output-7"></a> &lt;Transformer('code.extract_comments.v1', description='Parse comments and docstrings')&gt;]
</span></code></pre></div>
<p>You're now ready to use your custom transformer to process documents!</p>
<h3 id="testing-with-sample-documents">Testing with sample documents</h3>
<p>You can use the <a href="../../reference/lexy_py/transformer/#lexy_py.transformer.models.Transformer.transform_document"><code>Transformer.transform_document</code></a>
method to test your transformer on a sample document.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">code_transformer</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">get_transformer</span><span class="p">(</span><span class="s1">'code.extract_comments.v1'</span><span class="p">)</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="n">sample_doc</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="s1">'content'</span><span class="p">:</span> <span class="s1">'print("hello world")'</span><span class="p">,</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="s1">'meta'</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>      <span class="s1">'filename'</span><span class="p">:</span> <span class="s1">'example.py'</span>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>    <span class="p">}</span>
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="p">}</span>
</span><span id="__span-10-9"><a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>
</span><span id="__span-10-10"><a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="n">code_transformer</span><span class="o">.</span><span class="n">transform_document</span><span class="p">(</span><span class="n">sample_doc</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text no-copy result highlight" id="code-output"><pre><span></span><code><span id="__span-code-output-1"><a href="#__codelineno-code-output-1" id="__codelineno-code-output-1" name="__codelineno-code-output-1"></a>{'task_id': '65ecd2f7-bac4-4747-9e65-a6d21a72f585',
</span><span id="__span-code-output-2"><a href="#__codelineno-code-output-2" id="__codelineno-code-output-2" name="__codelineno-code-output-2"></a> 'result': [{'comment_text': 'my comment', 'comment_meta': {'line_no': 1, 'filename': 'example.py'}}]}
</span></code></pre></div>
<p>If your transformer code produces an error, you'll see the error message and traceback
in the response.</p>
<h2 id="updating-transformer-logic">Updating transformer logic</h2>
<p>The transformer we've created above is just an example. You may have also noticed that
we installed the <code>tree-sitter</code> and <code>tree-sitter-languages</code> packages in
<code>requirements.txt</code>, but we aren't using them.</p>
<p>Let's update <code>code.py</code> to actually parse comments from a variety of source code files.</p>
<div class="language-python highlight"><span class="filename">pipelines/code.py</span><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">import</span> <span class="nn">tree_sitter_languages</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">from</span> <span class="nn">lexy.models</span> <span class="kn">import</span> <span class="n">Document</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="kn">from</span> <span class="nn">lexy.transformers</span> <span class="kn">import</span> <span class="n">lexy_transformer</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="kn">from</span> <span class="nn">lexy.transformers.embeddings</span> <span class="kn">import</span> <span class="n">text_embeddings</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="n">lang_from_ext</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a>    <span class="s1">'cc'</span><span class="p">:</span> <span class="s1">'cpp'</span><span class="p">,</span>
</span><span id="__span-12-10"><a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a>    <span class="s1">'h'</span><span class="p">:</span> <span class="s1">'cpp'</span><span class="p">,</span>
</span><span id="__span-12-11"><a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a>    <span class="s1">'py'</span><span class="p">:</span> <span class="s1">'python'</span><span class="p">,</span>
</span><span id="__span-12-12"><a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a>    <span class="s1">'ts'</span><span class="p">:</span> <span class="s1">'typescript'</span><span class="p">,</span>
</span><span id="__span-12-13"><a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a>    <span class="s1">'tsx'</span><span class="p">:</span> <span class="s1">'tsx'</span><span class="p">,</span>
</span><span id="__span-12-14"><a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="p">}</span>
</span><span id="__span-12-15"><a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a>
</span><span id="__span-12-16"><a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="n">COMMENT_PATTERN_CPP</span> <span class="o">=</span> <span class="s2">"(comment) @comment"</span>
</span><span id="__span-12-17"><a href="#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="n">COMMENT_PATTERN_PY</span> <span class="o">=</span> <span class="s2">"""</span>
</span><span id="__span-12-18"><a href="#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="s2">    (module . (comment)* . (expression_statement (string)) @module_doc_str)</span>
</span><span id="__span-12-19"><a href="#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a>
</span><span id="__span-12-20"><a href="#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="s2">    (class_definition</span>
</span><span id="__span-12-21"><a href="#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="s2">        body: (block . (expression_statement (string)) @class_doc_str))</span>
</span><span id="__span-12-22"><a href="#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a>
</span><span id="__span-12-23"><a href="#__codelineno-12-23" id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="s2">    (function_definition</span>
</span><span id="__span-12-24"><a href="#__codelineno-12-24" id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="s2">        body: (block . (expression_statement (string)) @function_doc_str))</span>
</span><span id="__span-12-25"><a href="#__codelineno-12-25" id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="s2">"""</span>
</span><span id="__span-12-26"><a href="#__codelineno-12-26" id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="n">COMMENT_PATTERN_TS</span> <span class="o">=</span> <span class="s2">"(comment) @comment"</span>
</span><span id="__span-12-27"><a href="#__codelineno-12-27" id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="n">COMMENT_PATTERN_TSX</span> <span class="o">=</span> <span class="s2">"(comment) @comment"</span>
</span><span id="__span-12-28"><a href="#__codelineno-12-28" id="__codelineno-12-28" name="__codelineno-12-28"></a>
</span><span id="__span-12-29"><a href="#__codelineno-12-29" id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="n">comment_patterns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-30"><a href="#__codelineno-12-30" id="__codelineno-12-30" name="__codelineno-12-30"></a>    <span class="s1">'cpp'</span><span class="p">:</span> <span class="n">COMMENT_PATTERN_CPP</span><span class="p">,</span>
</span><span id="__span-12-31"><a href="#__codelineno-12-31" id="__codelineno-12-31" name="__codelineno-12-31"></a>    <span class="s1">'python'</span><span class="p">:</span> <span class="n">COMMENT_PATTERN_PY</span><span class="p">,</span>
</span><span id="__span-12-32"><a href="#__codelineno-12-32" id="__codelineno-12-32" name="__codelineno-12-32"></a>    <span class="s1">'typescript'</span><span class="p">:</span> <span class="n">COMMENT_PATTERN_TS</span><span class="p">,</span>
</span><span id="__span-12-33"><a href="#__codelineno-12-33" id="__codelineno-12-33" name="__codelineno-12-33"></a>    <span class="s1">'tsx'</span><span class="p">:</span> <span class="n">COMMENT_PATTERN_TSX</span>
</span><span id="__span-12-34"><a href="#__codelineno-12-34" id="__codelineno-12-34" name="__codelineno-12-34"></a><span class="p">}</span>
</span><span id="__span-12-35"><a href="#__codelineno-12-35" id="__codelineno-12-35" name="__codelineno-12-35"></a>
</span><span id="__span-12-36"><a href="#__codelineno-12-36" id="__codelineno-12-36" name="__codelineno-12-36"></a>
</span><span id="__span-12-37"><a href="#__codelineno-12-37" id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="nd">@lexy_transformer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'code.extract_comments.v1'</span><span class="p">)</span>
</span><span id="__span-12-38"><a href="#__codelineno-12-38" id="__codelineno-12-38" name="__codelineno-12-38"></a><span class="k">def</span> <span class="nf">get_comments</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="n">Document</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
</span><span id="__span-12-39"><a href="#__codelineno-12-39" id="__codelineno-12-39" name="__codelineno-12-39"></a>    <span class="n">lang</span> <span class="o">=</span> <span class="n">lang_from_ext</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">'file_ext'</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="s1">''</span><span class="p">))</span>
</span><span id="__span-12-40"><a href="#__codelineno-12-40" id="__codelineno-12-40" name="__codelineno-12-40"></a>    <span class="n">comment_pattern</span> <span class="o">=</span> <span class="n">comment_patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-12-41"><a href="#__codelineno-12-41" id="__codelineno-12-41" name="__codelineno-12-41"></a>
</span><span id="__span-12-42"><a href="#__codelineno-12-42" id="__codelineno-12-42" name="__codelineno-12-42"></a>    <span class="k">if</span> <span class="n">comment_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-12-43"><a href="#__codelineno-12-43" id="__codelineno-12-43" name="__codelineno-12-43"></a>        <span class="k">return</span> <span class="p">[]</span>
</span><span id="__span-12-44"><a href="#__codelineno-12-44" id="__codelineno-12-44" name="__codelineno-12-44"></a>
</span><span id="__span-12-45"><a href="#__codelineno-12-45" id="__codelineno-12-45" name="__codelineno-12-45"></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">tree_sitter_languages</span><span class="o">.</span><span class="n">get_parser</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
</span><span id="__span-12-46"><a href="#__codelineno-12-46" id="__codelineno-12-46" name="__codelineno-12-46"></a>    <span class="n">language</span> <span class="o">=</span> <span class="n">tree_sitter_languages</span><span class="o">.</span><span class="n">get_language</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
</span><span id="__span-12-47"><a href="#__codelineno-12-47" id="__codelineno-12-47" name="__codelineno-12-47"></a>
</span><span id="__span-12-48"><a href="#__codelineno-12-48" id="__codelineno-12-48" name="__codelineno-12-48"></a>    <span class="n">tree</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">))</span>
</span><span id="__span-12-49"><a href="#__codelineno-12-49" id="__codelineno-12-49" name="__codelineno-12-49"></a>    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">root_node</span>
</span><span id="__span-12-50"><a href="#__codelineno-12-50" id="__codelineno-12-50" name="__codelineno-12-50"></a>
</span><span id="__span-12-51"><a href="#__codelineno-12-51" id="__codelineno-12-51" name="__codelineno-12-51"></a>    <span class="n">query</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">comment_pattern</span><span class="p">)</span>
</span><span id="__span-12-52"><a href="#__codelineno-12-52" id="__codelineno-12-52" name="__codelineno-12-52"></a>    <span class="n">matches</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">captures</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span><span id="__span-12-53"><a href="#__codelineno-12-53" id="__codelineno-12-53" name="__codelineno-12-53"></a>    <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-12-54"><a href="#__codelineno-12-54" id="__codelineno-12-54" name="__codelineno-12-54"></a>    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="__span-12-55"><a href="#__codelineno-12-55" id="__codelineno-12-55" name="__codelineno-12-55"></a>        <span class="n">comment_text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
</span><span id="__span-12-56"><a href="#__codelineno-12-56" id="__codelineno-12-56" name="__codelineno-12-56"></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-57"><a href="#__codelineno-12-57" id="__codelineno-12-57" name="__codelineno-12-57"></a>            <span class="s1">'comment_text'</span><span class="p">:</span> <span class="n">comment_text</span><span class="p">,</span>
</span><span id="__span-12-58"><a href="#__codelineno-12-58" id="__codelineno-12-58" name="__codelineno-12-58"></a>            <span class="s1">'comment_embedding'</span><span class="p">:</span> <span class="n">text_embeddings</span><span class="p">(</span><span class="n">comment_text</span><span class="p">),</span>
</span><span id="__span-12-59"><a href="#__codelineno-12-59" id="__codelineno-12-59" name="__codelineno-12-59"></a>            <span class="s1">'comment_meta'</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-12-60"><a href="#__codelineno-12-60" id="__codelineno-12-60" name="__codelineno-12-60"></a>                <span class="s1">'start_point'</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">start_point</span><span class="p">,</span>
</span><span id="__span-12-61"><a href="#__codelineno-12-61" id="__codelineno-12-61" name="__codelineno-12-61"></a>                <span class="s1">'end_point'</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">end_point</span><span class="p">,</span>
</span><span id="__span-12-62"><a href="#__codelineno-12-62" id="__codelineno-12-62" name="__codelineno-12-62"></a>                <span class="s1">'type'</span><span class="p">:</span> <span class="n">name</span>
</span><span id="__span-12-63"><a href="#__codelineno-12-63" id="__codelineno-12-63" name="__codelineno-12-63"></a>            <span class="p">}</span>
</span><span id="__span-12-64"><a href="#__codelineno-12-64" id="__codelineno-12-64" name="__codelineno-12-64"></a>        <span class="p">}</span>
</span><span id="__span-12-65"><a href="#__codelineno-12-65" id="__codelineno-12-65" name="__codelineno-12-65"></a>        <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="__span-12-66"><a href="#__codelineno-12-66" id="__codelineno-12-66" name="__codelineno-12-66"></a>    <span class="k">return</span> <span class="n">comments</span>
</span></code></pre></div>
<p>Our updated code now takes a <code>Document</code> object and uses the file extension to determine
the appropriate language parser and comment patterns. It then parses comment text and
metadata, and also embeds the comment text using the <code>MiniLM</code> transformer.</p>
<p>When we update the transformer code, the <code>lexyworker</code> container will automatically
restart and load the new code. Let's test the updated transformer using a slightly more
complex sample document.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="n">sample_content</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span class="s1">'""" This is a module docstring. """</span><span class="se">\n</span><span class="s1">'</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>    <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a>    <span class="s1">'# This is a comment</span><span class="se">\n</span><span class="s1">'</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a>    <span class="s1">'class MyClass:</span><span class="se">\n</span><span class="s1">'</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a>    <span class="s1">'   """ This is a class docstring. """</span><span class="se">\n</span><span class="s1">'</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a>    <span class="s1">'   def __init__():</span><span class="se">\n</span><span class="s1">'</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a>    <span class="s1">'       # TODO: implement this</span><span class="se">\n</span><span class="s1">'</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a>    <span class="s1">'       pass</span><span class="se">\n</span><span class="s1">'</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a>    <span class="s1">''</span>
</span><span id="__span-13-11"><a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="p">)</span>
</span><span id="__span-13-12"><a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a>
</span><span id="__span-13-13"><a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="n">sample_doc</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-13-14"><a href="#__codelineno-13-14" id="__codelineno-13-14" name="__codelineno-13-14"></a>    <span class="s1">'content'</span><span class="p">:</span> <span class="n">sample_content</span><span class="p">,</span>
</span><span id="__span-13-15"><a href="#__codelineno-13-15" id="__codelineno-13-15" name="__codelineno-13-15"></a>    <span class="s1">'meta'</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-16"><a href="#__codelineno-13-16" id="__codelineno-13-16" name="__codelineno-13-16"></a>        <span class="s1">'file_name'</span><span class="p">:</span> <span class="s1">'example.py'</span><span class="p">,</span>
</span><span id="__span-13-17"><a href="#__codelineno-13-17" id="__codelineno-13-17" name="__codelineno-13-17"></a>        <span class="s1">'file_ext'</span><span class="p">:</span> <span class="s1">'.py'</span>
</span><span id="__span-13-18"><a href="#__codelineno-13-18" id="__codelineno-13-18" name="__codelineno-13-18"></a>    <span class="p">}</span>
</span><span id="__span-13-19"><a href="#__codelineno-13-19" id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="p">}</span>
</span><span id="__span-13-20"><a href="#__codelineno-13-20" id="__codelineno-13-20" name="__codelineno-13-20"></a>
</span><span id="__span-13-21"><a href="#__codelineno-13-21" id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="n">code_transformer</span><span class="o">.</span><span class="n">transform_document</span><span class="p">(</span><span class="n">sample_doc</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text no-copy result highlight" id="code-output"><pre><span></span><code><span id="__span-code-output-1"><a href="#__codelineno-code-output-1" id="__codelineno-code-output-1" name="__codelineno-code-output-1"></a>{'task_id': '48666991-308d-47ea-badf-3dd62f7b3778',
</span><span id="__span-code-output-2"><a href="#__codelineno-code-output-2" id="__codelineno-code-output-2" name="__codelineno-code-output-2"></a> 'result': [{'comment_text': '""" This is a module docstring. """',
</span><span id="__span-code-output-3"><a href="#__codelineno-code-output-3" id="__codelineno-code-output-3" name="__codelineno-code-output-3"></a>   'comment_embedding': [-0.028629321604967117, 0.10635735094547272, ..., 0.01644347794353962],
</span><span id="__span-code-output-4"><a href="#__codelineno-code-output-4" id="__codelineno-code-output-4" name="__codelineno-code-output-4"></a>   'comment_meta': {'start_point': [0, 0],
</span><span id="__span-code-output-5"><a href="#__codelineno-code-output-5" id="__codelineno-code-output-5" name="__codelineno-code-output-5"></a>    'end_point': [0, 35],
</span><span id="__span-code-output-6"><a href="#__codelineno-code-output-6" id="__codelineno-code-output-6" name="__codelineno-code-output-6"></a>    'type': 'module_doc_str'}},
</span><span id="__span-code-output-7"><a href="#__codelineno-code-output-7" id="__codelineno-code-output-7" name="__codelineno-code-output-7"></a>  {'comment_text': '""" This is a class docstring. """',
</span><span id="__span-code-output-8"><a href="#__codelineno-code-output-8" id="__codelineno-code-output-8" name="__codelineno-code-output-8"></a>   'comment_embedding': [-0.027630936354398727, 0.1391005963087082, ..., 0.07976623624563217],
</span><span id="__span-code-output-9"><a href="#__codelineno-code-output-9" id="__codelineno-code-output-9" name="__codelineno-code-output-9"></a>   'comment_meta': {'start_point': [4, 3],
</span><span id="__span-code-output-10"><a href="#__codelineno-code-output-10" id="__codelineno-code-output-10" name="__codelineno-code-output-10"></a>    'end_point': [4, 37],
</span><span id="__span-code-output-11"><a href="#__codelineno-code-output-11" id="__codelineno-code-output-11" name="__codelineno-code-output-11"></a>    'type': 'class_doc_str'}}]}
</span></code></pre></div>
<p>We can continue to iterate on our transformer code and test it on sample documents. Once
we're ready, we can create an index for storing the transformer output, and then create
a binding to apply the transformer to a collection of documents.</p>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.bd41221c.min.js"></script>
<script>document$.subscribe(() => {
            window.update_swagger_ui_iframe_height = function (id) {
                var iFrameID = document.getElementById(id);
                if (iFrameID) {
                    full_height = (iFrameID.contentWindow.document.body.scrollHeight + 80) + "px";
                    iFrameID.height = full_height;
                    iFrameID.style.height = full_height;
                }
            }
        
            let iframe_id_list = []
            var iframes = document.getElementsByClassName("swagger-ui-iframe");
            for (var i = 0; i < iframes.length; i++) { 
                iframe_id_list.push(iframes[i].getAttribute("id"))
            }
        
            let ticking = true;
            
            document.addEventListener('scroll', function(e) {
                if (!ticking) {
                    window.requestAnimationFrame(()=> {
                        let half_vh = window.innerHeight/2;
                        for(var i = 0; i < iframe_id_list.length; i++) {
                            let element = document.getElementById(iframe_id_list[i])
                            if(element==null){
                                return
                            }
                            let diff = element.getBoundingClientRect().top
                            if(element.contentWindow.update_top_val){
                                element.contentWindow.update_top_val(half_vh - diff)
                            }
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        
            const dark_scheme_name = "slate"
            
            window.scheme = document.body.getAttribute("data-md-color-scheme")
            const options = {
                attributeFilter: ['data-md-color-scheme'],
            };
            function color_scheme_callback(mutations) {
                for (let mutation of mutations) {
                    if (mutation.attributeName === "data-md-color-scheme") {
                        scheme = document.body.getAttribute("data-md-color-scheme")
                        var iframe_list = document.getElementsByClassName("swagger-ui-iframe")
                        for(var i = 0; i < iframe_list.length; i++) {
                            var ele = iframe_list.item(i);
                            if (ele) {
                                if (scheme === dark_scheme_name) {
                                    ele.contentWindow.enable_dark_mode();
                                } else {
                                    ele.contentWindow.disable_dark_mode();
                                }
                            }
                        }
                    }
                }
            }
            observer = new MutationObserver(color_scheme_callback);
            observer.observe(document.body, options);
            })</script></body>
</html>